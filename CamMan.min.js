var CamMan=function(){navigator.getUserMedia=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||false}();window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}();window.URL=function(){return window.URL||window.webkitURL||false}();var CamMan=function CamMan(options){this.snapshots=[];this.canvasStorage=[];this.video=null;this.events={};this.stream=null;this.options={audio:false,container:null};this.setOptions(options);return this};CamMan.prototype.createCanvas=function createCanvas(callback){var width=this.video.videoWidth;var height=this.video.videoHeight;if(width&&height){var canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var canvasEntry={canvas:canvas,context:canvas.getContext("2d"),onFrame:callback};if(this.canvasStorage.length===0)this.updateCanvas();this.canvasStorage.push(canvasEntry)}return canvas};CamMan.prototype.getCanvas=function getCanvas(container,callback){var element=document.querySelector("#"+container);return element.appendChild(this.createCanvas(callback))};CamMan.prototype.updateCanvas=function updateCanvas(){for(var i=0;i<this.canvasStorage.length;i++){var canvasEntry=this.canvasStorage[i];var canvas=this.canvasStorage[i]["canvas"];var context=this.canvasStorage[i]["context"];var callback=this.canvasStorage[i]["onFrame"];context.drawImage(this.video,0,0,canvas.width,canvas.height);if(callback)callback(canvas)}requestAnimationFrame(this.updateCanvas.bind(this))};CamMan.prototype.on=function on(event,handler){if(!this.events.hasOwnProperty(event))this.events[event]=[];this.events[event].push(handler)};CamMan.prototype.off=function off(event,handler){this.events=this.events[event].filter(function(h){if(h!==handler)return h})};CamMan.prototype.trigger=function trigger(event,data){if(!this.events.hasOwnProperty(event))return false;this.events[event].forEach(function(handler){handler.call(this,data)}.bind(this))};CamMan.prototype.setOptions=function setOptions(options){for(var option in options)this.options[option]=options[option]};CamMan.prototype.getStreamURL=function getStreamURL(){if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(this.stream);else return this.stream};CamMan.prototype.createVideo=function createVideo(){var width=320;var height=0;var streaming=false;var video=document.createElement("video");video.addEventListener("canplay",function(){if(!streaming){height=video.videoHeight/(video.videoWidth/width);video.style.width=width;video.style.height=height;streaming=true;return this.trigger("start")}}.bind(this),false);if(navigator.mozGetUserMedia)video.mozSrcObject=this.stream;else video.src=this.getStreamURL();video.play();return video};CamMan.prototype.snapshot=function snapshot(width,height){width=width||this.video.videoWidth;height=height||this.video.videoHeight;var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.width=width;canvas.height=height;context.drawImage(this.video,0,0,width,height);this.snapshots.push(canvas);this.trigger("snapshot",canvas);context=null;return canvas};CamMan.prototype.start=function start(){if(!navigator.getUserMedia){this.trigger("error","Browser not supported");return false}var success=function success(stream){this.stream=stream;this.video=this.createVideo();var container=this.options.container;if(typeof container==="string"){var element=document.querySelector("#"+container);element.appendChild(this.video)}}.bind(this);var error=function error(error){this.trigger("error",error)}.bind(this);var options={video:true,audio:this.options.audio};return navigator.getUserMedia(options,success,error)};CamMan.prototype.stop=function stop(){this.stream.stop();if(window.URL&&window.URL.revokeObjectURL){window.URL.revokeObjectURL(this.video.src)}return this.trigger("stop")};return CamMan}();var CamMan=function(){navigator.getUserMedia=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||false}();window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}();window.URL=function(){return window.URL||window.webkitURL||false}();var CamMan=function CamMan(options){this.snapshots=[];this.canvasStorage=[];this.video=null;this.events={};this.stream=null;this.options={audio:false,container:null};this.setOptions(options);return this};CamMan.prototype.createCanvas=function createCanvas(callback){var canvas=null;var width=this.video.videoWidth;var height=this.video.videoHeight;if(width&&height){canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var canvasData={canvas:canvas,context:canvas.getContext("2d"),onFrame:callback};if(this.canvasStorage.length===0)this.updateCanvas();this.canvasStorage.push(canvasData);return canvas}return canvas};CamMan.prototype.getCanvas=function getCanvas(container,callback){var element=document.querySelector("#"+container);return element.appendChild(this.createCanvas(callback))};CamMan.prototype.updateCanvas=function updateCanvas(){for(var i=0;i<this.canvasStorage.length;i++){var canvasData=this.canvasStorage[i];var canvas=canvasData.canvas;var context=canvasData.context;var callback=canvasData.onFrame;context.drawImage(this.video,0,0,canvas.width,canvas.height);if(callback)callback(canvas)}requestAnimationFrame(this.updateCanvas.bind(this))};CamMan.prototype.on=function on(event,handler){if(!this.events.hasOwnProperty(event))this.events[event]=[];this.events[event].push(handler)};CamMan.prototype.off=function off(event,handler){this.events=this.events[event].filter(function(h){if(h!==handler)return h})};CamMan.prototype.trigger=function trigger(event,data){if(!this.events.hasOwnProperty(event))return false;this.events[event].forEach(function(handler){handler.call(this,data)}.bind(this))};CamMan.prototype.setOptions=function setOptions(options){for(var option in options)this.options[option]=options[option]};CamMan.prototype.getStreamURL=function getStreamURL(){if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(this.stream);else return this.stream};CamMan.prototype.createVideo=function createVideo(){var width=320;var height=0;var streaming=false;var video=document.createElement("video");video.addEventListener("canplay",function(){if(!streaming){height=video.videoHeight/(video.videoWidth/width);video.style.width=width;video.style.height=height;streaming=true;return this.trigger("start")}}.bind(this),false);if(navigator.mozGetUserMedia)video.mozSrcObject=this.stream;else video.src=this.getStreamURL();video.play();return video};CamMan.prototype.snapshot=function snapshot(width,height){width=width||this.video.videoWidth;height=height||this.video.videoHeight;var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.width=width;canvas.height=height;context.drawImage(this.video,0,0,width,height);this.snapshots.push(canvas);this.trigger("snapshot",canvas);context=null;return canvas};CamMan.prototype.start=function start(){if(!navigator.getUserMedia){this.trigger("error","Browser not supported");return false}var success=function success(stream){this.stream=stream;this.video=this.createVideo();var container=this.options.container;if(typeof container==="string"){var element=document.querySelector("#"+container);element.appendChild(this.video)}}.bind(this);var error=function error(err){this.trigger("error",err)}.bind(this);var options={video:true,audio:this.options.audio};return navigator.getUserMedia(options,success,error)};CamMan.prototype.stop=function stop(){this.stream.stop();if(window.URL&&window.URL.revokeObjectURL){window.URL.revokeObjectURL(this.video.src)}return this.trigger("stop")};return CamMan}();